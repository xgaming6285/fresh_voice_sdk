; Asterisk Dialplan Configuration for Voice Agent Integration
; Place this in your /etc/asterisk/extensions.conf file
;
; IMPORTANT: Linked ID Tracking
; ===========================================================================
; This configuration includes Asterisk Linked ID tracking for call sessions.
; The linkedid is a call-wide unique identifier that remains consistent across
; all legs of a call (A-leg, B-leg, transfers, etc.).
;
; The dialplan sets the X-Asterisk-Linkedid custom header which the voice agent
; will capture and display in the terminal for tracking purposes.
;
; After updating this file, reload the dialplan:
;   asterisk -rx "dialplan reload"
;
; To verify linkedid is being captured, monitor the Asterisk console:
;   asterisk -rvvv
; ===========================================================================

[voice-agent-context]
; Context for incoming calls to the voice agent
; This is where calls from your SIM gateway will be routed

exten => _X.,1,NoOp(Voice Agent Call from ${CALLERID(num)} to ${EXTEN})
exten => _X.,n,Set(LINKEDID=${CHANNEL(linkedid)})
exten => _X.,n,NoOp(LinkedID for this call: ${LINKEDID})
; Add linkedid as custom SIP header so voice agent can capture it
exten => _X.,n,Set(PJSIP_HEADER(add,X-Asterisk-Linkedid)=${LINKEDID})
exten => _X.,n,Set(CHANNEL(hangup_handler_push)=hangup-handler,s,1)
exten => _X.,n,Answer()
exten => _X.,n,Set(SESSION_ID=${RAND(1000000,9999999)})
exten => _X.,n,AGI(voice_agent_agi.py,${SESSION_ID},${CALLERID(num)},${EXTEN})
exten => _X.,n,Hangup()

; Hangup handler to clean up sessions
[hangup-handler]
exten => s,1,NoOp(Cleaning up voice agent session ${SESSION_ID})
exten => s,n,System(/usr/bin/curl -X POST "http://localhost:8000/agi/end_call/${SESSION_ID}")
exten => s,n,Return()

[voice-agent-outbound]
; Context for outbound calls made by the voice agent
; Format: Dial(Local/NUMBER@voice-agent-outbound)

exten => _X.,1,NoOp(Voice Agent Outbound Call to ${EXTEN})
exten => _X.,n,Set(LINKEDID=${CHANNEL(linkedid)})
exten => _X.,n,NoOp(LinkedID for this call: ${LINKEDID})
; Add linkedid as custom SIP header so voice agent can capture it
exten => _X.,n,Set(PJSIP_HEADER(add,X-Asterisk-Linkedid)=${LINKEDID})
exten => _X.,n,Set(CALLERID(all)="Voice Agent" <1234>)
exten => _X.,n,Dial(SIP/${EXTEN}@your-sip-trunk,30,tT)
exten => _X.,n,Hangup()

[default]
; Main incoming context - route voice agent calls here
; Modify this section based on your existing dialplan

; Route specific numbers to voice agent
exten => 1000,1,Goto(voice-agent-context,${EXTEN},1)
exten => 2000,1,Goto(voice-agent-context,${EXTEN},1)

; Route all incoming calls from SIM gateway to voice agent
; Uncomment the line below if you want ALL incoming calls to go to the voice agent
; exten => _X.,1,Goto(voice-agent-context,${EXTEN},1)

[sip-trunk-incoming]
; Context for calls coming from your SIM gateway/SIP trunk
; Configure this based on your SIP trunk provider settings

exten => _X.,1,NoOp(Incoming call from SIM gateway: ${CALLERID(num)} to ${EXTEN})
exten => _X.,n,Set(CDR(accountcode)=voice-agent)
exten => _X.,n,Goto(voice-agent-context,${EXTEN},1)

; Example configuration for specific SIM cards/numbers
; exten => +1234567890,1,Goto(voice-agent-context,${EXTEN},1)
; exten => +0987654321,1,Goto(voice-agent-context,${EXTEN},1)

[globals]
; Global variables for voice agent integration
VOICE_AGENT_SERVER=localhost:8000
VOICE_AGENT_TIMEOUT=30

; SIP trunk configuration variables (adjust based on your setup)
SIP_TRUNK_HOST=your-sim-gateway-ip
SIP_TRUNK_USERNAME=your-sip-username
SIP_TRUNK_PASSWORD=your-sip-password

; Voice Agent Features
[voice-agent-features]
; Transfer to human operator (press 0 during call)
exten => 0,1,NoOp(Transfer to human operator)
exten => 0,n,Dial(SIP/operator@internal,20,tT)
exten => 0,n,Playback(vm-nobodyavail)
exten => 0,n,Return()

; Repeat menu (press *)
exten => *,1,NoOp(Repeat menu requested)
exten => *,n,Return()

; End call (#)
exten => #,1,NoOp(Call termination requested)
exten => #,n,Hangup()

[voice-agent-queue]
; Queue configuration for handling multiple simultaneous calls
; Enable this if you need call queuing functionality

exten => s,1,NoOp(Voice Agent Queue)
exten => s,n,Set(CHANNEL(hangup_handler_push)=hangup-handler,s,1)
exten => s,n,Answer()
exten => s,n,Queue(voice-agent-queue,tT,,,,60)
exten => s,n,Hangup()

; Queue member configuration (add this to queues.conf)
; [voice-agent-queue]
; strategy = ringall
; timeout = 20
; retry = 5
; maxlen = 10
; announce-frequency = 30
; announce-holdtime = yes
; member => Local/agent@voice-agent-context